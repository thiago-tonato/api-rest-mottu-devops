trigger:
  branches:
    include:
      - master
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: mottu-variables

stages:
  - stage: Build
    displayName: 'Build e Testes'
    jobs:
      - job: Build
        steps:
          - checkout: self

          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'

          - task: Maven@3
            displayName: 'Compilar e Testar'
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean test'
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'

  - stage: ContainerImage
    displayName: 'Build da Imagem no ACR'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: BuildContainerImage
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Buildar imagem no ACR'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: pscore
              scriptLocation: inlineScript
              inlineScript: |
                $ErrorActionPreference = 'Stop'

                $appImageRepo = '$(appImageName)'
                if ([string]::IsNullOrWhiteSpace($appImageRepo)) {
                  Write-Error 'Variável appImageName não está definida.'
                }

                $imageTag = '$(Build.BuildId)'
                Write-Host "Buildando imagem ${appImageRepo}:${imageTag} e latest no ACR $(acrName)..."
                az acr build `
                  --registry "$(acrName)" `
                  --image "${appImageRepo}:${imageTag}" `
                  --image "${appImageRepo}:latest" `
                  .

  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: ContainerImage
    condition: succeeded()
    jobs:
      - deployment: Deploy
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Criar ou atualizar container group'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: pscore
                    scriptLocation: inlineScript
                    inlineScript: |
                      $ErrorActionPreference = 'Stop'

                      function Require($value, $name) {
                        if ([string]::IsNullOrWhiteSpace($value)) {
                          Write-Error "Variável $name não definida no pipeline."
                        }
                        return $value
                      }

                      $resourceGroup = Require '$(resourceGroup)' 'resourceGroup'
                      $containerGroup = Require '$(containerGroupName)' 'containerGroupName'
                      $acrName = Require '$(acrName)' 'acrName'
                      $appImageRepo = Require '$(appImageName)' 'appImageName'
                      $mysqlImageRepo = Require '$(mysqlImageName)' 'mysqlImageName'
                      $mysqlImageTag = Require '$(mysqlImageTag)' 'mysqlImageTag'
                      $mysqlDatabase = Require '$(mysqlDatabase)' 'mysqlDatabase'
                      $mysqlUser = Require '$(mysqlUser)' 'mysqlUser'
                      $mysqlPassword = Require '$(mysqlPassword)' 'mysqlPassword'
                      $mysqlRootPassword = Require '$(mysqlRootPassword)' 'mysqlRootPassword'
                      $location = Require '$(location)' 'location'
                      $dnsLabel = Require '$(dnsLabel)' 'dnsLabel'

                      $appContainerName = '$(appContainerName)'
                      if ([string]::IsNullOrWhiteSpace($appContainerName)) { $appContainerName = 'qualitracker-app' }
                      $mysqlContainerName = '$(mysqlContainerName)'
                      if ([string]::IsNullOrWhiteSpace($mysqlContainerName)) { $mysqlContainerName = 'qualitracker-mysql' }

                      $loginServer = az acr show --name $acrName --query loginServer -o tsv
                      $imageTag = '$(Build.BuildId)'
                      $appImageFull = "$loginServer/$appImageRepo:$imageTag"
                      $mysqlImageFull = "$loginServer/$mysqlImageRepo:$mysqlImageTag"

                      Write-Host "Garantindo imagem MySQL ${mysqlImageRepo}:${mysqlImageTag} no ACR..."
                      $tagExists = az acr repository show-tags --name $acrName --repository $mysqlImageRepo --query "contains(@, '${mysqlImageTag}')" -o tsv 2>$null
                      if ($tagExists -ne 'true') {
                        az acr import --name $acrName --source "docker.io/library/mysql:$mysqlImageTag" --image "$mysqlImageRepo:$mysqlImageTag"
                      }

                      Write-Host 'Recuperando credenciais do ACR...'
                      $acrUsername = az acr credential show --name $acrName --query username -o tsv
                      $acrPassword = az acr credential show --name $acrName --query passwords[0].value -o tsv

                      Write-Host 'Removendo container group existente (se houver)...'
                      $exists = az container show --resource-group $resourceGroup --name $containerGroup >$null 2>&1
                      if ($LASTEXITCODE -eq 0) {
                        az container delete --resource-group $resourceGroup --name $containerGroup --yes --no-wait
                        Write-Host 'Aguardando remoção...'
                        do {
                          Start-Sleep -Seconds 5
                          az container show --resource-group $resourceGroup --name $containerGroup >$null 2>&1
                        } while ($LASTEXITCODE -eq 0)
                      }

                      Write-Host "Criando novo container group ${containerGroup}..."
                      $springDatasourceUrl = "jdbc:mysql://${mysqlContainerName}:3306/${mysqlDatabase}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"

                      $appContainer = @{ 
                        name = $appContainerName
                        properties = @{ 
                          image = $appImageFull
                          ports = @(@{ port = 8080 })
                          environmentVariables = @(
                            @{ name = 'SERVER_PORT'; value = '8080' },
                            @{ name = 'DB_HOST'; value = $mysqlContainerName },
                            @{ name = 'DB_PORT'; value = '3306' },
                            @{ name = 'SPRING_DATASOURCE_URL'; value = $springDatasourceUrl },
                            @{ name = 'SPRING_DATASOURCE_USERNAME'; value = $mysqlUser },
                            @{ name = 'SPRING_DATASOURCE_PASSWORD'; secureValue = $mysqlPassword },
                            @{ name = 'SPRING_FLYWAY_URL'; value = $springDatasourceUrl },
                            @{ name = 'SPRING_FLYWAY_USER'; value = $mysqlUser },
                            @{ name = 'SPRING_FLYWAY_PASSWORD'; secureValue = $mysqlPassword },
                            @{ name = 'JAVA_OPTS'; value = '-Xms256m -Xmx512m' }
                          )
                          resources = @{ requests = @{ cpu = 1.0; memoryInGB = 1.5 } }
                        }
                      }

                      $mysqlContainer = @{ 
                        name = $mysqlContainerName
                        properties = @{ 
                          image = $mysqlImageFull
                          ports = @(@{ port = 3306 })
                          environmentVariables = @(
                            @{ name = 'MYSQL_DATABASE'; value = $mysqlDatabase },
                            @{ name = 'MYSQL_USER'; value = $mysqlUser },
                            @{ name = 'MYSQL_PASSWORD'; secureValue = $mysqlPassword },
                            @{ name = 'MYSQL_ROOT_PASSWORD'; secureValue = $mysqlRootPassword }
                          )
                          resources = @{ requests = @{ cpu = 1.0; memoryInGB = 1.5 } }
                        }
                      }

                      $templateObject = @{ 
                        name = $containerGroup
                        location = $location
                        properties = @{ 
                          containers = @($appContainer, $mysqlContainer)
                          osType = 'Linux'
                          restartPolicy = 'Always'
                          imageRegistryCredentials = @(
                            @{ server = $loginServer; username = $acrUsername; password = $acrPassword }
                          )
                          ipAddress = @{ 
                            type = 'Public'
                            dnsNameLabel = $dnsLabel
                            ports = @(@{ protocol = 'TCP'; port = 8080 })
                          }
                        }
                      }

                      $templateJson = $templateObject | ConvertTo-Json -Depth 6
                      $tempFile = New-TemporaryFile
                      $templateJson | Out-File -FilePath $tempFile -Encoding utf8
                      try {
                        az container create --resource-group $resourceGroup --file $tempFile | Out-Null
                      }
                      finally {
                        Remove-Item $tempFile -Force
                      }

                      Write-Host "Container group ${containerGroup} criado com sucesso."
                      $appUrl = "http://${dnsLabel}.${location}.azurecontainer.io:8080"
                      Write-Host "Aplicação acessível em: $appUrl"

